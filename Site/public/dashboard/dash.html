<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia - Dashboard</title>
    <link rel="stylesheet" href="style/estilo.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />

    <link
      rel="shortcut icon"
      href="../home/imagem/dumbbell-solid.svg"
      type="image/x-icon"
    />
</head>
<body>
    <section>
        <div class="container">
          <div class="menu">
            <ul>
              <li>Bem Vindo! <span id="b_usuario"></span>.</li>
              <a href="../sobremim/sobre.html"><li>Sobre Mim</li></a>
              <a href="./dash.html"><li>Dashboard</li></a>
            </ul>
          </div>
        </div>
    </section>

    <div class="info">
        <div class="kpi">

            <div class="kpi-card">
                <h3>Motivação Mais Popular</h3>
                <p id="kpiMotivacao">Carregando...</p>
            </div>
            <div class="kpi-card">
                <h3>Idade com Maior Frequência</h3>
                <p id="kpiFrequencia">Carregando...</p>
            </div>

        </div>
        <div class="progresso">

            <h3>Evolução de Peso</h3>
            <canvas id="pesoChart"></canvas>
            
            <div>
                <h3>Peso</h3>
                <h3>Peso Alvo</h3>
            </div>
            <div>
                <input type="number" id="input_peso">
                <input type="number" id="input_pesoAlvo">
            </div>

            <button onclick="registrar()">Registrar</button>

        </div>

        <div class="dash">
            <h3>Média de frequência semanal por idade</h3>
            <canvas id="idadeFrequenciaChart" width="300px" height="300px"></canvas>
            <h3>Motivação dos usuários</h3>
            <canvas id="motivacaoChart"></canvas>
        </div>
        
    </div>


</body>
</html>
<script>

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    function registrar() {
    var peso = input_peso.value;
    var pesoAlvo = input_pesoAlvo.value;
    var fkUsuario = Number(sessionStorage.ID_USUARIO);

    console.log("Enviando:", { peso, pesoAlvo, fkUsuario });

    fetch("/dash/registrar", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            pesoServer: peso,
            pesoAlvoServer: pesoAlvo,
            fkUsuarioServer: fkUsuario,
        }),
    })
        .then((resposta) => {
            if (resposta.ok) {
                return resposta.json();
            } else {
                throw "Houve um erro ao tentar guardar os dados";
            }
        })
        .then((data) => {
            alert(data.mensagem);

            if (data.dados) {
                atualizarGraficoPeso(data.dados); 
            }
        })
        .catch((erro) => {
            console.error(`#ERRO: ${erro}`);
            alert("Erro ao atualizar gráfico!");
        });

    return false;
}

document.addEventListener('DOMContentLoaded', () => {
    const fkUsuario = sessionStorage.ID_USUARIO;

    if (!fkUsuario) {
        alert('ID do usuário não está definido!');
        return;
    }

    const atualizarGrafico = () => {
        fetch(`/dash/buscarPesos/${fkUsuario}`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados.');
                }
                return response.json();
            })
            .then((data) => {
                if (data && data.length > 0) {
                    console.log('Dados carregados:', data);

                    // Processar os dados do gráfico
                    const labels = data.map(item => new Date(item.dtRegistro).toLocaleDateString());
                    const pesos = data.map(item => item.peso);

                    // Preencher o peso-alvo com o último valor válido
                    let ultimoPesoAlvo = 0;
                    const pesosAlvo = data.map(item => {
                        if (item.pesoAlvo != null) {
                            ultimoPesoAlvo = item.pesoAlvo;
                        }
                        return ultimoPesoAlvo;
                    });

                    // Atualizar ou criar o gráfico
                    if (window.graficoPeso) {
                        // Atualizar dados no gráfico existente
                        window.graficoPeso.data.labels = labels;
                        window.graficoPeso.data.datasets[0].data = pesos;
                        window.graficoPeso.data.datasets[1].data = pesosAlvo;
                        window.graficoPeso.update();
                    } else {
                        
                        const ctx = document.getElementById('pesoChart').getContext('2d');
                        window.graficoPeso = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Peso Registrado',
                                        data: pesos,
                                        backgroundColor: '#c300ff',
                                        borderColor: 'white',
                                        borderWidth: 2
                                    },
                                    {
                                        label: 'Peso Alvo',
                                        data: pesosAlvo,
                                        type: 'line',
                                        borderColor: '#ff5252',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        pointRadius: 0,
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Peso (kg)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            })
            .catch((error) => {
                console.error('Erro ao carregar os dados do gráfico:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente mais tarde.');
            });
    };

    
    atualizarGrafico();

    
    setInterval(atualizarGrafico, 1000); 
});

document.addEventListener('DOMContentLoaded', () => {
    function gerarGraficoFrequenciaPorIdade() {
        fetch('/dash/frequenciaPorIdade')
            .then(response => response.json())
            .then(dados => {
                const idades = dados.map(item => item.idade);
                const frequencias = dados.map(item => item['Frequência Média']);
                
                // Criando o gráfico com os dados recebidos
                const ctx = document.getElementById('idadeFrequenciaChart').getContext('2d');
                new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: idades,
                        datasets: [{
                            label: 'Frequência Semanal de Treino (Média)',
                            data: frequencias,
                            backgroundColor: '#c300ff',
                            fill: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Idade'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Frequência Semanal (Dias)'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao buscar dados de frequência por idade:', error);
            });
    }

    // Chama a função para gerar o gráfico ao carregar a página
    gerarGraficoFrequenciaPorIdade();
});

document.addEventListener('DOMContentLoaded', () => {
        function gerarGraficoMotivacao() {
            fetch('/dash/contarMotivacao')
                .then(response => response.json())
                .then(dados => {
                    const motivacoes = dados.map(item => item.motivacao);
                    const total = dados.map(item => item.total);
                    
                    // Criando o gráfico com os dados recebidos
                    const ctx = document.getElementById('motivacaoChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: motivacoes,
                            datasets: [{
                                label: 'Número de Usuários',
                                data: total,
                                backgroundColor: '#c300ff',
                                borderColor: 'white',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Motivação'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Quantidade de Usuários'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar dados de motivação:', error);
                });
        }

        gerarGraficoMotivacao();
    });


    document.addEventListener("DOMContentLoaded", () => {
    const motivacaoPopularElement = document.getElementById("kpiMotivacao");
    const idadeFrequenciaElement = document.getElementById("kpiFrequencia");

    // Função para carregar motivação mais popular
    const carregarMotivacaoPopular = () => {
        fetch("/dash/kpiMotivacao")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Erro ao buscar a motivação mais popular");
                }
                return response.json();
            })
            .then((data) => {
                motivacaoPopularElement.textContent = data.motivacao || "Não disponível";
            })
            .catch((error) => {
                console.error("Erro ao carregar motivação popular:", error);
                motivacaoPopularElement.textContent = "Erro ao carregar";
            });
    };

    // Função para carregar idade com maior frequência
    const carregarIdadeFrequencia = () => {
        fetch("/dash/kpiFrequencia")
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Erro ao buscar a idade com maior frequência");
                }
                return response.json();
            })
            .then((data) => {
                if (data) {
                    const idade = data.idade;
                    const frequenciaMedia = data.frequenciaMedia;
                    idadeFrequenciaElement.textContent = `${idade} anos (${frequenciaMedia} dias/semana)`;
                } else {
                    idadeFrequenciaElement.textContent = "Não disponível";
                }
            })
            .catch((error) => {
                console.error("Erro ao carregar idade com maior frequência:", error);
                idadeFrequenciaElement.textContent = "Erro ao carregar";
            });
    };

    // Carregar as KPIs
    carregarMotivacaoPopular();
    carregarIdadeFrequencia();
});

</script>